<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PagamentoBean.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;ControlChefWeb&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">br.com.controlchefweb.bean</a> &gt; <span class="el_source">PagamentoBean.java</span></div><h1>PagamentoBean.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package br.com.controlchefweb.bean;

import br.com.controlchefweb.dao.ClienteDAO;
import br.com.controlchefweb.dao.ItemPedidoDAO;
import br.com.controlchefweb.dao.PagamentoDAO;
import br.com.controlchefweb.dao.PedidoDAO;
import br.com.controlchefweb.entidade.Cliente;
import br.com.controlchefweb.entidade.ItemPedido;
import br.com.controlchefweb.entidade.Pagamento;
import br.com.controlchefweb.entidade.Pedido;
import br.com.controlchefweb.util.SessionContext;
import br.com.controlchefweb.util.exception.ErroSistema;
import com.lowagie.text.*;
import com.lowagie.text.pdf.PdfWriter;
import java.awt.Color;
import java.awt.Font;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintWriter;
import java.io.Serializable;
import java.net.URL;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.annotation.PostConstruct;
import javax.faces.application.FacesMessage;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.SessionScoped;
import javax.faces.context.FacesContext;
import javax.servlet.http.HttpServletResponse;
import org.primefaces.context.RequestContext;
import org.primefaces.event.SelectEvent;

/**
 *
 * @author VashJHK
 */
@ManagedBean(name = &quot;pagamentoBean&quot;)
@SessionScoped
<span class="nc" id="L57">public class PagamentoBean implements Serializable {</span>

    private static final long serialVersionUID = 1L;

    private int step;
    private Pedido pedidoSelecionado;
    private Cliente clienteSelecionado;
    private Pagamento pagamento;

    private ClienteDAO clien;
    private PedidoDAO ped;
    private ItemPedidoDAO itemp;
    private PagamentoDAO paga;

    private String nome;

    private List&lt;Cliente&gt; clientesFiltrados;

    @PostConstruct
    public void init() {
        try {
<span class="nc" id="L78">            ped = new PedidoDAO();</span>
<span class="nc" id="L79">            itemp = new ItemPedidoDAO();</span>
<span class="nc" id="L80">            paga = new PagamentoDAO();</span>
<span class="nc" id="L81">            clien = new ClienteDAO();</span>
<span class="nc" id="L82">            pedidoSelecionado = new Pedido();</span>
<span class="nc" id="L83">            clienteSelecionado = new Cliente();</span>
<span class="nc" id="L84">            pagamento = new Pagamento();</span>
<span class="nc" id="L85">            clientesFiltrados = new ArrayList();</span>
<span class="nc" id="L86">            step = 1;</span>
<span class="nc" id="L87">            pagamento.setTaxa(paga.getarTaxa());</span>
<span class="nc" id="L88">            pagamento.setDesconto(paga.getarDesconto());</span>
<span class="nc" id="L89">        } catch (ErroSistema ex) {</span>
<span class="nc" id="L90">            Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">    }</span>

    public int getStep() {
<span class="nc" id="L95">        return step;</span>
    }

    public void setStep(int step) {
<span class="nc" id="L99">        this.step = step;</span>
<span class="nc" id="L100">    }</span>

    public Pedido getPedidoSelecionado() {
<span class="nc" id="L103">        return pedidoSelecionado;</span>
    }

    public void setPedidoSelecionado(Pedido pedidoSelecionado) {
<span class="nc" id="L107">        this.pedidoSelecionado = pedidoSelecionado;</span>
<span class="nc" id="L108">    }</span>

    public PedidoDAO getPed() {
<span class="nc" id="L111">        return ped;</span>
    }

    public void setPed(PedidoDAO ped) {
<span class="nc" id="L115">        this.ped = ped;</span>
<span class="nc" id="L116">    }</span>

    public ItemPedidoDAO getItemp() {
<span class="nc" id="L119">        return itemp;</span>
    }

    public void setItemp(ItemPedidoDAO itemp) {
<span class="nc" id="L123">        this.itemp = itemp;</span>
<span class="nc" id="L124">    }</span>

    public ClienteDAO getClien() {
<span class="nc" id="L127">        return clien;</span>
    }

    public void setClien(ClienteDAO clien) {
<span class="nc" id="L131">        this.clien = clien;</span>
<span class="nc" id="L132">    }</span>

    public PagamentoDAO getPaga() {
<span class="nc" id="L135">        return paga;</span>
    }

    public void setPaga(PagamentoDAO paga) {
<span class="nc" id="L139">        this.paga = paga;</span>
<span class="nc" id="L140">    }</span>

    public String getNome() {
<span class="nc" id="L143">        return nome;</span>
    }

    public void setNome(String nome) {
<span class="nc" id="L147">        this.nome = nome;</span>
<span class="nc" id="L148">    }</span>

    public List&lt;Cliente&gt; getClientesFiltrados() {
<span class="nc" id="L151">        return clientesFiltrados;</span>
    }

    public void setClientesFiltrados(List&lt;Cliente&gt; clientesFiltrados) {
<span class="nc" id="L155">        this.clientesFiltrados = clientesFiltrados;</span>
<span class="nc" id="L156">    }</span>

    public Cliente getClienteSelecionado() {
<span class="nc" id="L159">        return clienteSelecionado;</span>
    }

    public void setClienteSelecionado(Cliente clienteSelecionado) {
<span class="nc" id="L163">        this.clienteSelecionado = clienteSelecionado;</span>
<span class="nc" id="L164">    }</span>

    public Pagamento getPagamento() {
<span class="nc" id="L167">        return pagamento;</span>
    }

    public void setPagamento(Pagamento pagamento) {
<span class="nc" id="L171">        this.pagamento = pagamento;</span>
<span class="nc" id="L172">    }</span>

    public void pesquisar() throws ErroSistema {
<span class="nc" id="L175">        clientesFiltrados = clien.buscarNome(nome);</span>
<span class="nc" id="L176">    }</span>

    public void abrirDialogo() {
<span class="nc" id="L179">        Map&lt;String, Object&gt; opcoes = new HashMap&lt;&gt;();</span>
<span class="nc" id="L180">        opcoes.put(&quot;modal&quot;, true);</span>
<span class="nc" id="L181">        opcoes.put(&quot;resizable&quot;, false);</span>
<span class="nc" id="L182">        opcoes.put(&quot;contentHeight&quot;, 470);</span>

<span class="nc" id="L184">        RequestContext.getCurrentInstance().openDialog(&quot;SelecaoCliente&quot;, opcoes, null);</span>
<span class="nc" id="L185">    }</span>

    public void selecionar(Cliente cliente) {
<span class="nc" id="L188">        RequestContext.getCurrentInstance().closeDialog(cliente);</span>
<span class="nc" id="L189">    }</span>

    public void clienteSeleciona(SelectEvent event) {
<span class="nc" id="L192">        clienteSelecionado = (Cliente) event.getObject();</span>
<span class="nc" id="L193">        adicionarMensagem(&quot;Sucesso&quot;, &quot;Cliente selecionado com sucesso&quot;, FacesMessage.SEVERITY_INFO);</span>
<span class="nc" id="L194">    }</span>

    public void clienteCancelar() {
<span class="nc" id="L197">        clienteSelecionado = new Cliente();</span>
<span class="nc" id="L198">        pagamento.setCliente(clienteSelecionado);</span>
<span class="nc" id="L199">        adicionarMensagem(&quot;Sucesso&quot;, &quot;Cliente removido com sucesso.&quot;, FacesMessage.SEVERITY_INFO);</span>
<span class="nc" id="L200">    }</span>

    public void stepPedido(int mesa) {
        try {
<span class="nc" id="L204">            boolean controle = true;</span>

<span class="nc" id="L206">            pedidoSelecionado = ped.buscarPedido(mesa);</span>
<span class="nc" id="L207">            pedidoSelecionado.setItens(ped.buscarProdutoPedido(pedidoSelecionado.getId()));</span>
<span class="nc" id="L208">            pedidoSelecionado.setVendedor(SessionContext.getInstance().getUsuarioLogado());</span>
<span class="nc" id="L209">            double valorT = 0;</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">            for (ItemPedido s : pedidoSelecionado.getItens()) {</span>
<span class="nc" id="L211">                valorT += s.getValorItem();</span>
<span class="nc" id="L212">            }</span>
<span class="nc" id="L213">            pedidoSelecionado.setValorTotal(valorT);</span>
<span class="nc" id="L214">            double taxa = calcularTaxa();            </span>
<span class="nc" id="L215">            pagamento.setValorTaxa(taxa);</span>
<span class="nc" id="L216">            pagamento.setValorT(valorT + pagamento.getValorTaxa());</span>
            
           
            
<span class="nc bnc" id="L220" title="All 2 branches missed.">            for (ItemPedido s : pedidoSelecionado.getItens()) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (!s.isEntrega()) {</span>
<span class="nc" id="L222">                    controle = false;</span>
                }
<span class="nc" id="L224">            }</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">            if (controle) {</span>
<span class="nc" id="L226">                step++;</span>
            } else {
<span class="nc" id="L228">                adicionarMensagem(&quot;Atenção&quot;, &quot;Os itens do pedido não foram todos entregues.&quot;, FacesMessage.SEVERITY_WARN);</span>
            }
<span class="nc" id="L230">        } catch (ErroSistema ex) {</span>
<span class="nc" id="L231">            Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L232">        }</span>

<span class="nc" id="L234">    }</span>

    public void stepPagamento() throws ErroSistema {
<span class="nc" id="L237">        step++;</span>
<span class="nc" id="L238">        pagamento.setCliente(clienteSelecionado);</span>
<span class="nc" id="L239">        double desconto = calcularDesconto();</span>
<span class="nc" id="L240">        pagamento.setValorDesconto(desconto);</span>
        
<span class="nc" id="L242">        pagamento.setValorT(pedidoSelecionado.getValorTotal() + pagamento.getValorTaxa() - desconto);</span>

<span class="nc" id="L244">    }</span>

    public void stepFinalizar() {
<span class="nc bnc" id="L247" title="All 14 branches missed.">        switch (pagamento.getFormaPagamento()) {</span>
            case &quot;Dinheiro&quot;:
<span class="nc" id="L249">                pagamento.setTroco(pagamento.getValorPagamento() - pagamento.getValorT());</span>
<span class="nc" id="L250">                break;</span>
            case &quot;Cartão&quot;:
<span class="nc" id="L252">                pagamento.setValorPagamento(pagamento.getValorT());</span>
<span class="nc" id="L253">                pagamento.setTroco(0);</span>
<span class="nc" id="L254">                break;</span>
            case &quot;Cheque&quot;:
<span class="nc" id="L256">                pagamento.setTroco(pagamento.getValorPagamento() - pagamento.getValorT());</span>
                break;
        }
<span class="nc bnc" id="L259" title="All 2 branches missed.">        if (pagamento.getValorPagamento() &lt; pagamento.getValorT()) {</span>
<span class="nc" id="L260">            adicionarMensagem(&quot;Falha&quot;, &quot;O valor pago é menor que o exigido.&quot;, FacesMessage.SEVERITY_WARN);</span>
<span class="nc" id="L261">            return;</span>
        } else {
            try {
<span class="nc" id="L264">                step++;</span>
<span class="nc" id="L265">                pedidoSelecionado.setStatusPedido(false);</span>
<span class="nc" id="L266">                ped.salvar(pedidoSelecionado);</span>
<span class="nc" id="L267">                pedidoSelecionado.setPagamento(pagamento);</span>
<span class="nc" id="L268">                Date hj = new Date();</span>
<span class="nc" id="L269">                pedidoSelecionado.getPagamento().setDataPagamento(hj);</span>
<span class="nc" id="L270">                paga.criar(pedidoSelecionado);</span>
<span class="nc" id="L271">                gerarCupomNFiscal(pedidoSelecionado);</span>
<span class="nc" id="L272">                adicionarMensagem(&quot;Sucesso!&quot;, &quot;O pagamento foi finalizado com sucesso.&quot;, FacesMessage.SEVERITY_INFO);</span>

<span class="nc" id="L274">            } catch (ErroSistema ex) {</span>
<span class="nc" id="L275">                Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L276">            }</span>
        }
<span class="nc" id="L278">    }</span>
    
    public double calcularDesconto() throws ErroSistema {
<span class="nc" id="L281">        double desconto = 0;</span>
<span class="nc" id="L282">        double porcent = paga.getarDesconto();</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (pagamento.getCliente().getCpf() != null) {</span>
<span class="nc" id="L284">            desconto = (porcent * 0.01) * pedidoSelecionado.getValorTotal();</span>
<span class="nc" id="L285">            pagamento.setDesconto(porcent);</span>
        } else {
<span class="nc" id="L287">            pagamento.setDesconto(0);</span>
        }

<span class="nc" id="L290">        return desconto;</span>
    }
    
    public double calcularTaxa() throws ErroSistema {
<span class="nc" id="L294">        double taxa = 0;</span>
<span class="nc" id="L295">        double porcent = paga.getarTaxa();</span>

<span class="nc" id="L297">        taxa = (porcent * 0.01) * pedidoSelecionado.getValorTotal();</span>
<span class="nc" id="L298">        return taxa;</span>
    }
      

    public void gerarCupomNFiscal(Pedido pedido) {
        try {

<span class="nc" id="L305">            int count = 0;</span>
<span class="nc" id="L306">            File arquivo = new File(diretorioRaiz(), &quot;Pedido_de_ID_&quot; + pedido.getId() + &quot;.txt&quot;);</span>
<span class="nc" id="L307">            SimpleDateFormat fmt = new SimpleDateFormat(&quot;dd/MM/yyyy HH:mm:ss&quot;);</span>

<span class="nc" id="L309">            FileWriter arquivoTxt = new FileWriter(arquivo, true);</span>
<span class="nc" id="L310">            PrintWriter linhasTxt = new PrintWriter(arquivoTxt);</span>
            //ACREDITO QUE SO PODE TER 42 CARACTERES
<span class="nc" id="L312">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L313">            linhasTxt.println(&quot;                ControlChef                &quot;);</span>
<span class="nc" id="L314">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L315">            linhasTxt.println(&quot;********** NAO E DOCUMENTO FISCAL *********&quot;);</span>
<span class="nc" id="L316">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L317">            linhasTxt.println(&quot;OPERACAO - ID:   &quot; + pedido.getId());</span>
<span class="nc" id="L318">            linhasTxt.println(&quot;DATA:              &quot; + fmt.format(pedido.getPagamento().getDataPagamento()));</span>
<span class="nc" id="L319">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L320">            linhasTxt.println(&quot; FUNCIONARIO: &quot; + pedido.getVendedor().getNome());</span>
<span class="nc" id="L321">            linhasTxt.println(&quot;-------------------------------------------&quot;);</span>
<span class="nc" id="L322">            linhasTxt.println(&quot; CONSUMIDOR - CPF:      &quot; + pedido.getPagamento().getCliente().getCpf());</span>
<span class="nc" id="L323">            linhasTxt.println(&quot; NOME: &quot; + pedido.getPagamento().getCliente().getNome());</span>
//                linhasTxt.println(&quot; GARCOM  CONTA.DIV.  VAL.PESS. COVER  DESC.&quot;);
//                linhasTxt.print(String.format(&quot;%7s  %9s  %9s  %5s   %s&quot;,
//                                  &quot;garcom&quot;,
//                                  &quot;------------&quot;,
//                                  &quot;vlpessoa&quot;,
//                                  &quot;cover&quot;,
//                                  &quot;desconto&quot;
//                                  //garcom.getText(),
//                                  //dividirConta.getText(),
//                                  //valorPorPessoa.getText(),
//                                  //cover.getText(),
//                                  //descontoConta.getText()
//                                  ));
<span class="nc" id="L337">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L338">            linhasTxt.println(&quot;PRODUTO      QTDE      VALOR UN.  VALOR(R$)&quot;);</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">            for (ItemPedido s : pedido.getItens()) {</span>
<span class="nc" id="L340">                linhasTxt.print(String.format(&quot;%-10.10s&quot;, s.getProduto().getNome()));</span>
<span class="nc" id="L341">                linhasTxt.print(String.format(&quot;%7s     &quot;, s.getQuantidade()));</span>
<span class="nc" id="L342">                linhasTxt.print(String.format(&quot;%10s    &quot;, String.format(&quot;%.2f&quot;, s.getProduto().getPreco())));</span>
<span class="nc" id="L343">                linhasTxt.print(String.format(&quot;%7s&quot;, String.format(&quot;%.2f&quot;, s.getValorItem())));</span>
<span class="nc" id="L344">                linhasTxt.println();</span>
<span class="nc" id="L345">                count++;</span>
<span class="nc" id="L346">            }</span>
<span class="nc" id="L347">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L348">            linhasTxt.println(&quot;SubTotal                    R$&quot; + String.format(&quot;%.2f&quot;, pedido.getValorTotal()));</span>
<span class="nc" id="L349">            linhasTxt.println(&quot;TAXA SERVICO               +R$&quot; + String.format(&quot;%.2f&quot;, pedido.getPagamento().getValorTaxa())+ &quot;(&quot; + String.format(&quot;%.1f&quot;,pedido.getPagamento().getTaxa()) + &quot;%)&quot;);</span>
<span class="nc" id="L350">            linhasTxt.println(&quot;DESCONTO                   -R$&quot; + String.format(&quot;%.2f&quot;, pedido.getPagamento().getValorDesconto()) + &quot;(&quot; + String.format(&quot;%.1f&quot;,pedido.getPagamento().getDesconto()) + &quot;%)&quot;);</span>
<span class="nc" id="L351">            linhasTxt.println(&quot;                   ------------------------&quot;);</span>
<span class="nc" id="L352">            linhasTxt.println(&quot;Total                       R$&quot; + String.format(&quot;%.2f&quot;, pedido.getPagamento().getValorT()));</span>
<span class="nc" id="L353">            linhasTxt.println(&quot;                   ------------------------&quot;);</span>
<span class="nc" id="L354">            linhasTxt.println(&quot;Valor Pago                  R$&quot; + String.format(&quot;%.2f&quot;, pedido.getPagamento().getValorPagamento()));</span>
<span class="nc" id="L355">            linhasTxt.println(&quot;Troco                       R$&quot; + String.format(&quot;%.2f&quot;, pedido.getPagamento().getTroco()));</span>
<span class="nc" id="L356">            linhasTxt.println(&quot;FORMA DE PAGAMENTO             &quot; + pedido.getPagamento().getFormaPagamento());</span>
<span class="nc" id="L357">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L358">            linhasTxt.println(&quot;                VOLTE SEMPRE!              &quot;);</span>
<span class="nc" id="L359">            linhasTxt.println();</span>
<span class="nc" id="L360">            linhasTxt.println(&quot;===========================================&quot;);</span>
<span class="nc" id="L361">            arquivoTxt.close();</span>

<span class="nc" id="L363">            txtToPdf(pedido.getId(), count);</span>
<span class="nc" id="L364">        } catch (IOException ex) {</span>
<span class="nc" id="L365">            Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L366">        }</span>
<span class="nc" id="L367">    }</span>

    public String escreverSobrenome(String nome) {
<span class="nc" id="L370">        String sobrenome = nome.split(&quot; &quot;)[nome.split(&quot; &quot;).length - 1];</span>
<span class="nc" id="L371">        return sobrenome;</span>
    }

    public File diretorioRaiz() {
<span class="nc" id="L375">        URL location = getClass().getProtectionDomain().getCodeSource().getLocation();</span>
<span class="nc" id="L376">        String diretorio = location.toString();</span>
<span class="nc" id="L377">        String diretorio0 = diretorio.replaceAll(&quot;file:/&quot;, &quot;&quot;);</span>

<span class="nc" id="L379">        diretorio = diretorio0.substring(0, diretorio0.indexOf(&quot;ControlChefWeb&quot;) + 14);</span>

<span class="nc" id="L381">        File dirRaiz = new File(diretorio, &quot;ControlChefWebUP&quot;);</span>
<span class="nc" id="L382">        File dir = new File(dirRaiz, &quot;Fiscal&quot;);</span>
<span class="nc" id="L383">        return dir;</span>
    }

    public void txtToPdf(int a, int b) {
<span class="nc" id="L387">        FileReader reader = null;</span>
        try {
<span class="nc" id="L389">            reader = new FileReader(diretorioRaiz().getPath() + &quot;\\Pedido_de_ID_&quot; + a + &quot;.txt&quot;);</span>
<span class="nc" id="L390">            BufferedReader leitor = new BufferedReader(reader);</span>

            //criação do pdf                         //  (Es, Dir,Sup,Inf)
<span class="nc" id="L393">            Rectangle pagesize = new Rectangle(228f, 347f + b * 12);</span>
<span class="nc" id="L394">            Document document = new Document(pagesize, 10, 10, 0, 10);</span>
<span class="nc" id="L395">            PdfWriter.getInstance(document, new FileOutputStream(diretorioRaiz().getPath() + &quot;\\Pedido_de_ID_&quot; + a + &quot;.pdf&quot;));</span>
<span class="nc" id="L396">            document.open();</span>
            //Ler txt linha a linha 
<span class="nc bnc" id="L398" title="All 2 branches missed.">            while (leitor.ready()) {</span>
<span class="nc" id="L399">                document.add(new Paragraph(leitor.readLine(), FontFactory.getFont(FontFactory.COURIER, 8, Font.PLAIN, new Color(0, 0, 0))));</span>
            }
<span class="nc" id="L401">            leitor.close();</span>
<span class="nc" id="L402">            document.close();</span>
<span class="nc" id="L403">        } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L404">            Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L405">        } catch (DocumentException ex) {</span>
<span class="nc" id="L406">            Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L407">        } catch (IOException ex) {</span>
<span class="nc" id="L408">            Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
        } finally {
<span class="nc" id="L410">            try {</span>
<span class="nc" id="L411">                reader.close();</span>
<span class="nc" id="L412">            } catch (IOException ex) {</span>
<span class="nc" id="L413">                Logger.getLogger(PagamentoBean.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L414">            }</span>
<span class="nc" id="L415">        }</span>

<span class="nc" id="L417">    }</span>

    public void cancelar() {
<span class="nc" id="L420">        step--;</span>
<span class="nc" id="L421">    }</span>

    public void confirmar() {
<span class="nc" id="L424">        step = 1;</span>
<span class="nc" id="L425">        init();</span>
<span class="nc" id="L426">    }</span>

    public void adicionarMensagem(String mensagem, String mensagem2, FacesMessage.Severity tipoErro) {
<span class="nc" id="L429">        FacesMessage fm = new FacesMessage(tipoErro, mensagem, mensagem2);</span>
<span class="nc" id="L430">        FacesContext.getCurrentInstance().addMessage(null, fm);</span>
<span class="nc" id="L431">    }</span>

    public void exVisualizarPDF(){
<span class="nc" id="L434">        importarArquivo(pedidoSelecionado);</span>
<span class="nc" id="L435">        visualizarPdf(pedidoSelecionado);</span>
<span class="nc" id="L436">    }</span>
    
    // Array de bytes que armazenará o conteúdo do arquivo PDF
    private byte[] conteudoPdf;

    public void importarArquivo(Pedido pedido) {
        try {
            // Cria um objeto File a partir do caminho especificado
<span class="nc" id="L444">            File file = new File(diretorioRaiz().getPath() + &quot;\\Pedido_de_ID_&quot; + pedido.getId() + &quot;.pdf&quot;);</span>

            // Inicializa o array bytes com o tamanho do arquivo especificado.
            // Note a conversao para int, restringindo a capacidade maxima do
            // arquivo em 2 GB
<span class="nc" id="L449">            conteudoPdf = new byte[(int) file.length()];</span>

            // Cria um InputStream a partir do objeto File
<span class="nc" id="L452">            InputStream is = new FileInputStream(file);</span>

            // Aqui o InputStream faz a leitura do arquivo, transformando em um
            // array de bytes
<span class="nc" id="L456">            is.read(conteudoPdf);</span>

            // Fecha o InputStream, liberando seus recursos
<span class="nc" id="L459">            is.close();</span>
<span class="nc" id="L460">        } catch (Exception e) {</span>
<span class="nc" id="L461">            e.printStackTrace();</span>
<span class="nc" id="L462">        }</span>
<span class="nc" id="L463">    }</span>

    public void visualizarPdf(Pedido pedido) {

<span class="nc" id="L467">        FacesContext fc = FacesContext.getCurrentInstance();</span>

        // Obtem o HttpServletResponse, objeto responsável pela resposta do
        // servidor ao browser
<span class="nc" id="L471">        HttpServletResponse response = (HttpServletResponse) fc</span>
<span class="nc" id="L472">                .getExternalContext().getResponse();</span>

        // Limpa o buffer do response
<span class="nc" id="L475">        response.reset();</span>

        // Seta o tipo de conteudo no cabecalho da resposta. No caso, indica que o
        // conteudo sera um documento pdf.
<span class="nc" id="L479">        response.setContentType(&quot;application/pdf&quot;);</span>

        // Seta o tamanho do conteudo no cabecalho da resposta. No caso, o tamanho
        // em bytes do pdf
<span class="nc" id="L483">        response.setContentLength(conteudoPdf.length);</span>

        // Seta o nome do arquivo e a disposição: &quot;inline&quot; abre no próprio
        // navegador.
        // Mude para &quot;attachment&quot; para indicar que deve ser feito um download
<span class="nc" id="L488">        response.setHeader(&quot;Content-disposition&quot;, &quot;inline; filename=Pedido_de_ID_&quot;+pedido.getId()+&quot;.pdf&quot;);</span>
        try {

            // Envia o conteudo do arquivo PDF para o response
<span class="nc" id="L492">            response.getOutputStream().write(conteudoPdf);</span>

            // Descarrega o conteudo do stream, forçando a escrita de qualquer byte
            // ainda em buffer
<span class="nc" id="L496">            response.getOutputStream().flush();</span>

            // Fecha o stream, liberando seus recursos
<span class="nc" id="L499">            response.getOutputStream().close();</span>

            // Sinaliza ao JSF que a resposta HTTP para este pedido já foi gerada
<span class="nc" id="L502">            fc.responseComplete();</span>
<span class="nc" id="L503">        } catch (IOException e) {</span>
<span class="nc" id="L504">            e.printStackTrace();</span>
<span class="nc" id="L505">        }</span>
<span class="nc" id="L506">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>